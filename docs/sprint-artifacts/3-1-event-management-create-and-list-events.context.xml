<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.1</storyId>
    <title>Event Management - Create and List Events</title>
    <status>drafted</status>
    <generatedAt>2025-11-26T15:30:00Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3-1-event-management-create-and-list-events.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>dispatcher</asA>
    <iWant>create operational events and see them in a list</iWant>
    <soThat>all dispatchers are aware of important information in real-time</soThat>
    <tasks>
      <task id="1" ac="1,2,4">
        <name>Create Event API endpoint</name>
        <subtasks>
          <subtask>Create /api/events/route.ts with GET and POST handlers</subtask>
          <subtask>Implement Zod validation schema for event creation (title: 1-50 chars, description: 0-200 chars, priority: CRITICAL|NORMAL)</subtask>
          <subtask>Add authentication check using auth() from NextAuth</subtask>
          <subtask>Implement Prisma create with audit logging</subtask>
          <subtask>Return standardized API response format { success: true, data: Event }</subtask>
        </subtasks>
      </task>
      <task id="2" ac="2">
        <name>Implement SSE broadcast for new events</name>
        <subtasks>
          <subtask>Use existing broadcastSSE from lib/sse.ts with type "event_created"</subtask>
          <subtask>Broadcast { type: "event_created", data: event } on POST success</subtask>
          <subtask>Verify less than 2 second delivery to all connected clients</subtask>
        </subtasks>
      </task>
      <task id="3" ac="1,3,5">
        <name>Create EventList component</name>
        <subtasks>
          <subtask>Create components/events/EventList.tsx</subtask>
          <subtask>Fetch events from /api/events on mount</subtask>
          <subtask>Sort events: CRITICAL priority first, then by createdAt DESC</subtask>
          <subtask>Display empty state when no events</subtask>
          <subtask>Subscribe to SSE for real-time updates</subtask>
        </subtasks>
      </task>
      <task id="4" ac="1,3">
        <name>Create EventCard component</name>
        <subtasks>
          <subtask>Create components/events/EventCard.tsx</subtask>
          <subtask>Display title, description, priority, timestamp</subtask>
          <subtask>Apply red styling for CRITICAL priority events</subtask>
          <subtask>Standard styling for NORMAL priority</subtask>
        </subtasks>
      </task>
      <task id="5" ac="1">
        <name>Create EventForm component</name>
        <subtasks>
          <subtask>Create components/events/EventForm.tsx</subtask>
          <subtask>Use shadcn/ui Dialog for modal form</subtask>
          <subtask>Implement react-hook-form with Zod resolver</subtask>
          <subtask>Add "Ny hendelse" button to trigger dialog</subtask>
          <subtask>Submit to POST /api/events</subtask>
        </subtasks>
      </task>
      <task id="6" ac="1,3,5">
        <name>Integrate into Hva Skjer page</name>
        <subtasks>
          <subtask>Update ViktigeMeldinger component in components/hva-skjer/viktige-meldinger.tsx</subtask>
          <subtask>Add EventList to left column</subtask>
          <subtask>Add "Ny hendelse" button in header</subtask>
          <subtask>Ensure SSE connection is established</subtask>
        </subtasks>
      </task>
      <task id="7" ac="1-5">
        <name>Test and verify</name>
        <subtasks>
          <subtask>Manual test: Create event, verify appears in list</subtask>
          <subtask>Manual test: Open two browser tabs, create event, verify sync</subtask>
          <subtask>Verify AuditLog entry created after event creation</subtask>
          <subtask>Verify empty state displays correctly</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC3.1.1">Event created with title, description, priority appears in "Viktige meldinger" list immediately</criterion>
    <criterion id="AC3.1.2">All connected dispatchers see new event via SSE broadcast in less than 2 seconds</criterion>
    <criterion id="AC3.1.3">Events are sorted with Pri 1 (CRITICAL) at top, then by createdAt timestamp DESC</criterion>
    <criterion id="AC3.1.4">Event creation is logged in AuditLog with creator's user_id and timestamp</criterion>
    <criterion id="AC3.1.5">Empty state message displays "Ingen hendelser" when no events exist</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-3.md" relevance="high">Technical specification for Epic 3 with API contracts, data models, and acceptance criteria</doc>
      <doc path="docs/architecture.md" relevance="high">System architecture with API response format, SSE patterns, error handling, and implementation patterns</doc>
      <doc path="prisma/schema.prisma" relevance="high">Database schema with Event model, Priority enum, EventStatus enum</doc>
    </docs>
    <code>
      <file path="lib/auth.ts" relevance="high" purpose="authentication">
        <description>NextAuth configuration with auth() export for session validation</description>
        <usage>Import { auth } from "@/lib/auth" and call await auth() to get session</usage>
      </file>
      <file path="lib/prisma.ts" relevance="high" purpose="database">
        <description>Prisma client singleton with audit extension</description>
        <usage>Import { prisma } from "@/lib/prisma" for database operations</usage>
      </file>
      <file path="lib/sse.ts" relevance="high" purpose="real-time">
        <description>SSE broadcast utility with broadcastSSE function and event types including "event_created"</description>
        <usage>Import { broadcastSSE } from "@/lib/sse" and call broadcastSSE("event_created", eventData)</usage>
      </file>
      <file path="lib/audit.ts" relevance="medium" purpose="audit logging">
        <description>Prisma extension for automatic audit logging - Event table is already in AUDITED_TABLES</description>
        <usage>Audit logging happens automatically via Prisma extension when creating/updating/deleting Event records</usage>
      </file>
      <file path="components/hva-skjer/viktige-meldinger.tsx" relevance="high" purpose="integration point">
        <description>Current placeholder component for events - this is where EventList will be integrated</description>
        <usage>Replace placeholder content with EventList component and add EventForm button</usage>
      </file>
      <file path="components/hva-skjer/hva-skjer-layout.tsx" relevance="medium" purpose="layout context">
        <description>Layout structure showing ViktigeMeldinger in left column (full height)</description>
        <usage>No changes needed - ViktigeMeldinger is already placed correctly</usage>
      </file>
      <file path="app/api/sse/route.ts" relevance="medium" purpose="SSE endpoint">
        <description>SSE endpoint that establishes persistent connection - already functional</description>
        <usage>Clients connect via EventSource("/api/sse")</usage>
      </file>
      <file path="components/ui/dialog.tsx" relevance="high" purpose="UI component">
        <description>shadcn/ui Dialog component for EventForm modal</description>
        <usage>Import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog"</usage>
      </file>
      <file path="components/ui/button.tsx" relevance="high" purpose="UI component">
        <description>shadcn/ui Button component</description>
        <usage>Import { Button } from "@/components/ui/button"</usage>
      </file>
      <file path="components/ui/input.tsx" relevance="high" purpose="UI component">
        <description>shadcn/ui Input component for form fields</description>
        <usage>Import { Input } from "@/components/ui/input"</usage>
      </file>
      <file path="components/ui/card.tsx" relevance="high" purpose="UI component">
        <description>shadcn/ui Card component for EventCard</description>
        <usage>Import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"</usage>
      </file>
      <file path="components/ui/select.tsx" relevance="high" purpose="UI component">
        <description>shadcn/ui Select component for priority selection</description>
        <usage>Import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"</usage>
      </file>
    </code>
    <dependencies>
      <dependency name="zod" version="^3.23.8" purpose="Schema validation for API request/response">Already installed</dependency>
      <dependency name="react-hook-form" version="^7.53.2" purpose="Form handling">Already installed</dependency>
      <dependency name="@hookform/resolvers" version="^3.9.1" purpose="Zod resolver for react-hook-form">Already installed</dependency>
      <dependency name="lucide-react" version="^0.454.0" purpose="Icons (Plus icon for new event button)">Already installed</dependency>
      <dependency name="zustand" version="^5.0.8" purpose="State management for events (optional)">Already installed</dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="security">All API endpoints must validate authentication using auth() from NextAuth</constraint>
    <constraint type="security">Input validation required using Zod schemas before database operations</constraint>
    <constraint type="api">API responses must use wrapped format: { success: true, data: ... } or { success: false, error: { message, code } }</constraint>
    <constraint type="api">HTTP status codes: 200 (success), 201 (created), 400 (validation), 401 (unauthorized), 500 (server error)</constraint>
    <constraint type="performance">SSE broadcast must deliver events in less than 2 seconds</constraint>
    <constraint type="database">Event model uses soft delete pattern - deletedAt field for story 3.2 (not this story)</constraint>
    <constraint type="i18n">Error messages should be in Norwegian (e.g., "Du må være logget inn", "Ugyldig data")</constraint>
  </constraints>

  <interfaces>
    <api endpoint="GET /api/events" method="GET">
      <description>Fetch all active events, sorted by priority then createdAt DESC</description>
      <response>{ success: true, data: Event[] }</response>
      <queryParams>Optional: ?status=ACTIVE, ?priority=CRITICAL</queryParams>
    </api>
    <api endpoint="POST /api/events" method="POST">
      <description>Create a new event</description>
      <request>{ title: string (1-50), description: string (0-200), priority: "CRITICAL" | "NORMAL" }</request>
      <response>{ success: true, data: Event }</response>
      <sideEffect>Broadcasts SSE event_created to all connected clients</sideEffect>
      <sideEffect>Creates AuditLog entry automatically via Prisma extension</sideEffect>
    </api>
    <sse eventType="event_created">
      <description>Broadcast when new event is created</description>
      <payload>{ type: "event_created", data: Event, timestamp: ISO8601 }</payload>
    </sse>
  </interfaces>

  <tests>
    <standards>
      <standard>Manual verification for MVP (no unit tests required)</standard>
      <standard>Multi-tab testing for SSE sync verification</standard>
      <standard>Check AuditLog table after operations</standard>
    </standards>
    <locations>
      <location>Manual browser testing</location>
      <location>Prisma Studio for database verification</location>
    </locations>
    <ideas>
      <testIdea ac="AC3.1.1">Create event with title, description, priority - verify appears in list immediately</testIdea>
      <testIdea ac="AC3.1.2">Open two browser tabs, create event in one, verify appears in other within 2 seconds</testIdea>
      <testIdea ac="AC3.1.3">Create CRITICAL and NORMAL events, verify CRITICAL appears at top</testIdea>
      <testIdea ac="AC3.1.4">Create event, query AuditLog table to verify entry with userId, tableName, actionType</testIdea>
      <testIdea ac="AC3.1.5">View ViktigeMeldinger with no events, verify "Ingen hendelser" message</testIdea>
    </ideas>
  </tests>

  <dataModels>
    <model name="Event" table="Event">
      <field name="id" type="String" default="uuid()" notes="Primary key"/>
      <field name="title" type="String" maxLength="50" notes="@db.VarChar(50)"/>
      <field name="description" type="String" maxLength="200" notes="@db.VarChar(200)"/>
      <field name="priority" type="Priority" default="NORMAL" notes="Enum: CRITICAL (Pri 1, red), NORMAL"/>
      <field name="status" type="EventStatus" default="ACTIVE" notes="Enum: ACTIVE, RESOLVED, ARCHIVED"/>
      <field name="createdBy" type="String" notes="User ID of creator"/>
      <field name="createdAt" type="DateTime" default="now()"/>
      <field name="updatedAt" type="DateTime" notes="@updatedAt"/>
      <field name="deletedAt" type="DateTime?" notes="Soft delete (story 3.2)"/>
      <field name="deletedBy" type="String?" notes="User who deleted (story 3.2)"/>
      <indexes>
        <index fields="priority, createdAt"/>
        <index fields="status"/>
      </indexes>
    </model>
    <enum name="Priority">
      <value>CRITICAL</value>
      <value>NORMAL</value>
    </enum>
    <enum name="EventStatus">
      <value>ACTIVE</value>
      <value>RESOLVED</value>
      <value>ARCHIVED</value>
    </enum>
  </dataModels>

  <codePatterns>
    <pattern name="API Route">
      <example><![CDATA[
// app/api/events/route.ts
import { NextResponse } from "next/server";
import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { broadcastSSE } from "@/lib/sse";
import { z } from "zod";

const createEventSchema = z.object({
  title: z.string().min(1).max(50),
  description: z.string().max(200).default(""),
  priority: z.enum(["CRITICAL", "NORMAL"]).default("NORMAL"),
});

export async function POST(request: Request) {
  try {
    const session = await auth();
    if (!session?.user?.id) {
      return NextResponse.json(
        { success: false, error: { message: "Du må være logget inn", code: "UNAUTHORIZED" } },
        { status: 401 }
      );
    }

    const body = await request.json();
    const validated = createEventSchema.parse(body);

    const event = await prisma.event.create({
      data: {
        ...validated,
        createdBy: session.user.id,
      },
    });

    // Broadcast to all connected dispatchers
    broadcastSSE("event_created", event);

    return NextResponse.json({ success: true, data: event }, { status: 201 });
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { success: false, error: { message: "Ugyldig data", code: "VALIDATION_ERROR" } },
        { status: 400 }
      );
    }
    console.error("[EVENT]", "Create failed", error);
    return NextResponse.json(
      { success: false, error: { message: "Kunne ikke opprette hendelse", code: "INTERNAL_ERROR" } },
      { status: 500 }
    );
  }
}
      ]]></example>
    </pattern>
    <pattern name="SSE Client Hook">
      <example><![CDATA[
// Custom hook for SSE connection
import { useEffect, useState } from "react";

export function useSSE<T>(eventType: string) {
  const [data, setData] = useState<T | null>(null);

  useEffect(() => {
    const eventSource = new EventSource("/api/sse");

    eventSource.onmessage = (event) => {
      const parsed = JSON.parse(event.data);
      if (parsed.type === eventType) {
        setData(parsed.data);
      }
    };

    eventSource.onerror = () => {
      console.warn("[SSE] Connection error, will auto-reconnect");
    };

    return () => eventSource.close();
  }, [eventType]);

  return data;
}
      ]]></example>
    </pattern>
  </codePatterns>
</story-context>
