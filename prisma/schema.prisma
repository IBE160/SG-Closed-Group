// Prisma schema file for Hva Skjer - Emergency Response Application
// Epic 1: Foundation & Infrastructure - Story 1.2

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  OPERATOR
  ADMINISTRATOR
}

enum Priority {
  CRITICAL // Pri 1 (Red)
  NORMAL
}

enum EventStatus {
  ACTIVE
  RESOLVED
  ARCHIVED
}

enum VehicleStatusType {
  READY // Green - available
  OUT // Red - just responded
  OUT_OF_SERVICE // Grey - maintenance/training
}

enum BonfireStatus {
  ACTIVE
  EXPIRED
  FLAGGED_FOR_REVIEW
}

enum BonfireSource {
  MANUAL // Phase 1: Manual entry
  AI_APPROVED // Phase 2: AI auto-created
  AI_REVIEWED // Phase 2: AI flagged, human approved
}

// ============================================================================
// MODELS
// ============================================================================

// User Model - Authentication and RBAC
model User {
  id          String    @id @default(uuid())
  email       String    @unique
  name        String?
  whitelisted Boolean   @default(false)
  role        Role      @default(OPERATOR)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  sessions    Session[]

  @@index([email])
}

// Session Model - NextAuth.js JWT sessions
model Session {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  sessionToken String   @unique
  accessToken  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

// Event Model - Operational events (Epic 3)
model Event {
  id          String      @id @default(uuid())
  title       String      @db.VarChar(50)
  description String      @db.VarChar(200)
  priority    Priority    @default(NORMAL)
  status      EventStatus @default(ACTIVE)
  createdBy   String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?
  deletedBy   String?

  @@index([priority, createdAt])
  @@index([status])
}

// FlashMessage Model - Urgent dispatcher communication (Epic 4)
model FlashMessage {
  id        String   @id @default(uuid())
  content   String   @db.VarChar(100)
  createdBy String
  createdAt DateTime @default(now())
  expiresAt DateTime // Auto-archive after 24 hours

  @@index([createdAt])
}

// VehicleStatus Model - Truck rotation (S111, S112) (Epic 3)
model VehicleStatus {
  id        String            @id @default(uuid())
  vehicleId String            @unique // "S111" or "S112"
  status    VehicleStatusType @default(OUT)
  note      String?           @db.VarChar(50) // Grey status reason
  updatedBy String
  updatedAt DateTime          @updatedAt

  @@index([vehicleId])
}

// DutyRoster Model - Weekly personnel assignments (Epic 3)
// Fixed structure: Vakt09 + Lederstøtte (no generic positions)
// Updated 2025-11-27 via correct-course workflow
model DutyRoster {
  id               String   @id @default(uuid())
  weekNumber       Int      // ISO week number (1-53)
  year             Int
  vakt09Name       String?  @db.VarChar(100)  // Vakt09 assigned person
  lederstotteName  String?  @db.VarChar(100)  // Lederstøtte assigned person
  lederstottePhone String?  @db.VarChar(20)   // Lederstøtte phone number
  updatedBy        String?  @db.VarChar(100)  // Who last updated
  updatedByName    String?  @db.VarChar(100)  // Display name of updater
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([weekNumber, year])  // One entry per week
  @@index([weekNumber, year])
}

// Talegruppe Model - Radio talk group assignments (Epic 3)
// Added 2025-11-27 via correct-course workflow
model Talegruppe {
  id            String   @id @default(uuid())
  name          String   @db.VarChar(50)   // e.g., "Skogbrann-01"
  details       String   @db.VarChar(200)  // e.g., "06-Brann-19"
  createdBy     String?  @db.VarChar(100)  // User ID who created
  createdByName String?  @db.VarChar(100)  // Display name of creator
  updatedBy     String?  @db.VarChar(100)  // User ID who last updated
  updatedByName String?  @db.VarChar(100)  // Display name of last updater
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([createdAt])
}

// BonfireRegistration Model - Bonfire notifications (Epic 5)
model BonfireRegistration {
  id             String        @id @default(uuid())
  registrantName String        @db.VarChar(100)
  phone          String        @db.VarChar(20)
  address        String        @db.VarChar(200)
  municipality   String        @db.VarChar(50)
  lat            Float
  lng            Float
  bonfireSize    String        @db.VarChar(50) // "Small", "Medium", "Large"
  dateFrom       DateTime
  dateTo         DateTime
  notes          String?       @db.Text
  status         BonfireStatus @default(ACTIVE)
  source         BonfireSource @default(MANUAL)
  confidence     Float? // AI extraction confidence (0-1)
  rawEmail       String?       @db.Text // Original email for audit
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  expiresAt      DateTime // Auto-set to dateTo
  deletedAt      DateTime? // GDPR: soft delete after 90 days

  @@index([municipality, dateFrom])
  @@index([status, expiresAt])
  @@index([lat, lng])
}

// AuditLog Model - Complete action history for compliance
model AuditLog {
  id         String   @id @default(uuid())
  userId     String
  userEmail  String
  timestamp  DateTime @default(now())
  tableName  String   @db.VarChar(50)
  recordId   String   @db.VarChar(100)
  actionType String   @db.VarChar(20) // CREATE, UPDATE, DELETE
  oldValues  Json? // JSONB snapshot
  newValues  Json? // JSONB snapshot

  @@index([timestamp(sort: Desc)])
  @@index([tableName])
  @@index([userId])
}
