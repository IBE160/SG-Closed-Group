# Epic 2 Retrospective: Authentication & Access Control

**Date:** 2025-12-02
**Epic:** Epic 2 - Authentication & Access Control
**Team Members:** BIP + medstudent

---

## Epic Summary

Epic 2 implementerte et komplett autentiserings- og tilgangskontrollsystem med:
- Google OAuth via NextAuth.js v5 (Auth.js)
- Whitelist-basert tilgangskontroll
- Rollebasert tilgang (Operatør/Administrator)
- Beskyttede ruter og API-endepunkter
- Profesjonell login-side og brukerprofil-UI
- Sikker sesjonsbehandling med 16-timers varighet

### Stories Completed
| Story | Status |
|-------|--------|
| 2-1 NextAuth.js Configuration with Google OAuth | Done |
| 2-2 User Whitelist Management System | Done |
| 2-3 Role-Based Access Control (RBAC) | Done |
| 2-4 Protected Routes and API Endpoints | Done |
| 2-5 Login Page and User Profile UI | Done |
| 2-6 Session Management and Security Hardening | Done |

---

## What Went Well

### 1. NextAuth.js v5 Migrering
- Vellykket implementering av Auth.js (NextAuth v5) med nye patterns
- JWT-strategi fungerte godt med Prisma-adapter
- Google OAuth-integrasjon var sømløs etter korrekt oppsett

### 2. Whitelist-system
- Enkel og effektiv tilgangskontroll
- Kun forhåndsgodkjente e-postadresser får tilgang
- Administrator-grensesnitt for å legge til/fjerne brukere

### 3. Middleware-beskyttelse
- All trafikk beskyttet via Next.js middleware
- Automatisk redirect til login for uautentiserte brukere
- Callback URL bevares for sømløs brukeropplevelse

---

## Challenges Encountered

### 1. NextAuth v4 vs v5 Forskjeller
- **Problem:** Dokumentasjon blandet v4 og v5 patterns
- **Løsning:** Fulgte Auth.js offisiell migrasjonsguide nøye
- **Lærdom:** `AUTH_` prefix for miljøvariabler, ny `auth()` funksjon

### 2. Edge Runtime Kompatibilitet
- **Problem:** Prisma-adapter fungerer ikke i Edge runtime
- **Løsning:** Brukte JWT-strategi som fungerer på Edge
- **Resultat:** Middleware kan kjøre på Edge uten database-tilgang

### 3. Session Type Extensions
- **Problem:** TypeScript klaget på egendefinerte session-felter
- **Løsning:** Opprettet `next-auth.d.ts` med type declarations
- **Resultat:** Full type-sikkerhet for `session.user.role` og `session.user.id`

---

## Lessons Learned

### Dokumentasjonsversjonering er Kritisk
> NextAuth v5 har breaking changes. Sjekk alltid at eksempler matcher versjon du bruker.

**Anbefaling for fremtidige prosjekter:**
- Bruk offisiell Auth.js dokumentasjon (authjs.dev)
- Unngå eldre tutorials som refererer til `NEXTAUTH_` prefixer
- Test autentisering tidlig i prosjektet

### Miljøvariabler
- `AUTH_SECRET` - Obligatorisk i produksjon
- `AUTH_GOOGLE_ID` og `AUTH_GOOGLE_SECRET` - Auto-detektert av Auth.js
- `NEXTAUTH_URL` - Fortsatt nødvendig for callback URLs

---

## Key Decisions Made

| Beslutning | Begrunnelse |
|------------|-------------|
| JWT-strategi over database sessions | Edge-kompatibilitet + bedre ytelse |
| 16-timers sesjonsvarighet | Dekker 12-timers skift + buffer |
| Whitelist over open registration | Kun autoriserte operatører skal ha tilgang |
| Google OAuth som eneste provider | Alle brukere har @gmail eller Google Workspace |

---

## Technical Artifacts

### New/Modified Files
- `auth.ts` - Hoved Auth.js konfigurasjon
- `app/api/auth/[...nextauth]/route.ts` - API route handlers
- `middleware.ts` - Rutebeskyttelse
- `app/login/page.tsx` - Login-side
- `app/access-denied/page.tsx` - Tilgang nektet-side
- `components/layout/UserProfile.tsx` - Brukerprofil dropdown
- `lib/authorize.ts` - RBAC hjelpefunksjoner
- `types/next-auth.d.ts` - Type extensions

### Security Measures Implemented
- HttpOnly cookies
- Secure cookies i produksjon
- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- Strict Referrer-Policy

---

## Dependencies Enabled

Epic 2 la grunnlaget for alle påfølgende epics:

| Epic | Avhengighet |
|------|-------------|
| Epic 3: Event Control | `auth()` for API-beskyttelse, `session.user.id` for audit |
| Epic 4: Flash Messages | `session.user.id` for createdBy-felt |
| Epic 5: Bålmelding | Beskyttede ruter, rollebasert tilgang for admin-kø |

---

## Overall Assessment

Epic 2 ble vellykket fullført med alle 6 stories implementert. Autentiseringssystemet har fungert stabilt gjennom hele prosjektet uten sikkerhetsproblemer.

**Hovedsuksesser:**
- Sømløs Google OAuth-integrasjon
- Robust whitelist-system
- Skalerbar RBAC-implementasjon

**Ting som kunne vært bedre:**
- Mer tid på å forstå v5-endringer før implementering
- Kunne hatt refresh token rotation for enda bedre sikkerhet

---

**Status:** Complete
**Next Epic:** Epic 3 - Event Control Dashboard
