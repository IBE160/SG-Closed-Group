# Epic 4 Retrospective: Flash Message System

**Date:** 2025-12-02
**Epic:** Epic 4 - Flash Message System
**Team Members:** BIP + medstudent

---

## Epic Summary

Epic 4 implementerte et sanntids flash-meldingssystem for operatør-til-operatør kommunikasjon:
- Full-skjerm flash-varsel i 20 sekunder
- Klikk-for-å-kvittere på hele skjermen
- Navigasjon mellom siste 5 meldinger
- 1-sekunds polling for sanntidsoppdateringer
- Avsender ser ikke sin egen flash

### Stories Completed
| Story | Status | Merknad |
|-------|--------|---------|
| 4-1 Flash Message Basic Send and Receive | Done | SSE + polling |
| 4-2 Blink Animation and Acknowledgment | Done | 20-sek full-skjerm flash |
| 4-3 Smart Typing Detection and Auto-Switch | Skipped | Nødmelding må alltid fange oppmerksomhet |
| 4-4 Message History and Multiple Messages | Done | Pil-navigasjon i FlashBar |
| 4-5 Auto-Return Timer and Flash Folder UI | Skipped | FlashBar alltid synlig - ingen separat fane |
| 4-6 Flash Message Performance Optimization | Done | 1-sek polling implementert |

---

## What Went Well

### 1. Full-Skjerm Flash-varsel
- Sterk visuell indikator som fanger oppmerksomhet
- 20 sekunders varighet gir nok tid til å reagere
- Klikk hvor som helst på skjermen for å kvittere

### 2. Avsender-ekskludering
- Senderen ser ikke sin egen flash-varsel
- Implementert via `isOwnMessage` parameter i Zustand store
- Forhindrer unødvendig distraksjon for avsenderen

### 3. Alltid-Synlig FlashBar
- Plassert øverst i layouten på alle sider
- Operatører mister aldri meldinger
- Eliminerer behovet for separat Flash-fane

### 4. Zustand State Management
- `useFlashStore` for all flash-tilstand
- `fullScreenFlash` boolean for overlay-kontroll
- Timer-håndtering med useRef for cleanup

---

## Challenges Encountered

### 1. SSE Ustabilitet på Vercel
- **Problem:** SSE-tilkoblinger droppes på Vercel serverless
- **Løsning:** 1-sekunds polling som primær leveringsmekanisme
- **Resultat:** Pålitelig meldingslevering uavhengig av SSE-status

### 2. Timing av Flash-stopp
- **Problem:** Flash måtte stoppe etter 20 sek ELLER ved klikk
- **Løsning:** useEffect med setTimeout + cleanup i return
- **Resultat:** Korrekt timer-håndtering uten memory leaks

### 3. Sender Skal Ikke Se Flash
- **Problem:** Opprinnelig flashet for alle, inkludert avsender
- **Løsning:** `addMessage(msg, true)` med isOwnMessage flag
- **Resultat:** Kun mottakere ser full-skjerm flash

### 4. Overlay Click-Through
- **Problem:** Overlay blokkerte interaksjon med underliggende elementer
- **Løsning:** `pointer-events: auto` med onClick handler
- **Resultat:** Brukere kan klikke på overlay for å kvittere

---

## Lessons Learned

### Enklere er Ofte Bedre
> Stories 4-3 og 4-5 ble skippet fordi enklere arkitektur var mer hensiktsmessig.

**Typing Detection (4-3):**
- For nødsituasjoner må flash-varsler ALLTID fange oppmerksomhet
- Å skjule varsler fordi bruker taster ville vært kontraproduktivt

**Auto-Return Timer (4-5):**
- FlashBar er alltid synlig øverst
- Ingen separat Flash-fane = ingen grunn til auto-retur

### Timer-Håndtering i React
> useRef + cleanup i useEffect er kritisk for timers.

```typescript
useEffect(() => {
  if (fullScreenFlash) {
    timerRef.current = setTimeout(() => {
      stopFullScreenFlash();
    }, 20000);

    return () => {
      if (timerRef.current) clearTimeout(timerRef.current);
    };
  }
}, [fullScreenFlash]);
```

---

## Key Decisions Made

| Beslutning | Begrunnelse |
|------------|-------------|
| 20 sekunders flash | Lang nok til å fange oppmerksomhet uten å være irriterende |
| Full-skjerm overlay | Garanterer at varselet sees uansett hvor bruker ser |
| Skip typing detection | Nødvarsler må alltid være synlige |
| Skip Flash-fane | FlashBar alltid synlig gjør separat fane unødvendig |
| 1-sek polling | Mer pålitelig enn SSE på Vercel |

---

## Technical Artifacts

### New/Modified Files
- `components/layout/flash-bar.tsx` - FlashBar med meldingsvisning
- `components/layout/app-layout.tsx` - Full-skjerm overlay og timer
- `stores/useFlashStore.ts` - Zustand store med fullScreenFlash state
- `app/globals.css` - Flash-animasjoner (0.4s cycle)
- `app/api/flash/route.ts` - Flash API med SSE broadcast

### State Management
```typescript
interface FlashState {
  messages: FlashMessage[];
  currentIndex: number;
  acknowledgedIds: string[];
  blinkPhase: BlinkPhase;
  fullScreenFlash: boolean;  // NY: Kontrollerer overlay

  addMessage: (msg, isOwnMessage?) => void;
  acknowledge: (id) => void;
  stopFullScreenFlash: () => void;  // NY: Stopper overlay
}
```

### CSS Animations
```css
@keyframes flash-screen-overlay {
  0%, 100% { background-color: transparent; }
  50% { background-color: hsl(var(--destructive) / 0.7); }
}
.animate-flash-screen {
  animation: flash-screen-overlay 0.4s ease-in-out infinite;
}
```

---

## Overall Assessment

Epic 4 ble vellykket fullført med 4 av 6 stories implementert og 2 bevisst skippet. Den endelige løsningen er enklere og mer hensiktsmessig enn den opprinnelige planen.

**Hovedsuksesser:**
- Kraftig visuell varsling for nødsituasjoner
- Pålitelig meldingslevering
- Intuitiv klikk-for-å-kvittere
- Ren arkitektur med Zustand

**Ting som fungerte bra:**
- BMAD tillot å skippe unødvendige stories med dokumentert begrunnelse
- Enkel alltid-synlig FlashBar eliminerte kompleksitet
- Full-skjerm overlay er svært effektiv for å fange oppmerksomhet

---

**Status:** Complete
**Stories Skipped:** 4-3 (typing detection), 4-5 (auto-return)
**Skipped Justification:** Enklere arkitektur mer hensiktsmessig for nødsituasjoner
**Next Epic:** Epic 5 - Bålmelding (Bonfire) Registration
